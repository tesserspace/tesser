name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

env:
  CARGO_TERM_COLOR: always
  PACKAGE_NAME: tesser-cli

jobs:
  # 1. Verification Phase (Dry Run)
  # Uses cargo-release's default dry-run behavior to verify config and state.
  check-dry-run:
    name: Verify and Dry Run
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-release
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-release

      - name: Check cargo publish (Dry Run)
        # explicit --dry-run for clarity, though it is default
        run: cargo release ${{ github.event.inputs.version }} --dry-run --no-push --no-tag --no-publish

      - name: Check compilation
        run: cargo check --release

  # 2. State Mutation Phase
  # Bump version, create git tag locally, then push.
  tag-and-push:
    name: Bump Version and Tag
    needs: check-dry-run
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      changelog: ${{ steps.changelog.outputs.body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-release, git-cliff

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Bump version and commit
        # --execute applies changes locally.
        # --no-publish skips crates.io (we do that last).
        # --no-push skips git push (we do that explicitly later).
        run: cargo release ${{ github.event.inputs.version }} --execute --no-publish --no-push

      - name: Determine tag name
        id: tag
        run: |
          TAG=$(git describe --tags --exact-match)
          
          if [ -z "$TAG" ]; then
             echo "::error::No tag was created by cargo-release!"
             exit 1
          fi
          
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          echo "Captured tag: $TAG"

      - name: Generate changelog
        id: changelog
        run: |
          git-cliff --latest --strip all > RELEASE_NOTES.md
          {
            echo 'body<<EOF'
            cat RELEASE_NOTES.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Push changes
        run: git push origin HEAD:refs/heads/main --tags

  # 3. Build Phase
  # Compile binaries for all targets. If this fails, Crates.io is not polluted.
  build-artifacts:
    name: Build Artifacts
    needs: tag-and-push
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.tag-and-push.outputs.tag_name }}

      - name: Install musl-tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build binary
        run: cargo build --package ${{ env.PACKAGE_NAME }} --release --target ${{ matrix.target }}

      - name: Package binary
        shell: bash
        run: |
          set -euo pipefail
          
          CLI_NAME="${{ env.PACKAGE_NAME }}"
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            CLI_NAME="${{ env.PACKAGE_NAME }}.exe"
          fi
          
          ARTIFACT_NAME="${{ env.PACKAGE_NAME }}-${{ needs.tag-and-push.outputs.tag_name }}-${{ matrix.target }}"
          mkdir -p "$ARTIFACT_NAME"
          
          cp "target/${{ matrix.target }}/release/${CLI_NAME}" "$ARTIFACT_NAME/"
          
          if [[ "${{ matrix.archive }}" == "zip" ]]; then
            ARCHIVE_PATH="${ARTIFACT_NAME}.zip"
            7z a "$ARCHIVE_PATH" "./$ARTIFACT_NAME/*" >/dev/null
          else
            ARCHIVE_PATH="${ARTIFACT_NAME}.tar.gz"
            tar -czf "$ARCHIVE_PATH" -C "$ARTIFACT_NAME" .
          fi
          
          echo "ASSET_PATH=$ARCHIVE_PATH" >> "$GITHUB_ENV"

      - name: Upload intermediate artifact
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.target }}
          path: ${{ env.ASSET_PATH }}
          retention-days: 1

  # 4. Publication Phase
  # Final step: Create GH Release and Publish to Crates.io
  publish-final:
    name: Publish to Registry and GitHub
    needs: [tag-and-push, build-artifacts]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.tag-and-push.outputs.tag_name }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Download built artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bin-*
          path: dist
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.tag-and-push.outputs.tag_name }}
          name: ${{ needs.tag-and-push.outputs.tag_name }}
          body: ${{ needs.tag-and-push.outputs.changelog }}
          files: dist/*
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute publish order
        id: publish_order
        run: |
          ORDER=$(python .github/scripts/compute_publish_order.py)
          {
            echo 'crates<<EOF'
            echo "$ORDER"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Publish to Crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "::error::CRATES_IO_TOKEN secret is not configured."
            exit 1
          fi
          while IFS= read -r crate; do
            [ -z "$crate" ] && continue
            echo "::group::Publishing $crate"
            cargo publish -p "$crate"
            echo "::endgroup::"
            sleep 30
          done <<< "${{ steps.publish_order.outputs.crates }}"
