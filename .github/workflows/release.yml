name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version bump type (patch, minor, major)
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

env:
  CARGO_TERM_COLOR: always

jobs:
  prepare-release:
    name: Prepare release artifacts
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      changelog: ${{ steps.changelog.outputs.body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install release tooling
        run: |
          cargo install cargo-release --locked
          cargo install git-cliff --locked

      - name: Configure Git author
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Run cargo release
        run: cargo release ${{ github.event.inputs.version }} --execute --no-publish

      - name: Determine tag name
        id: tag
        run: |
          set -euo pipefail
          TAG=$(git tag --list --sort=-creatordate | head -n1)
          if [ -z "$TAG" ]; then
            TAG="v$(python - <<'PY'
import tomllib
with open("Cargo.toml","rb") as f:
    data = tomllib.load(f)
print(data["workspace"]["package"]["version"])
PY
)"
          fi
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        id: changelog
        run: |
          git-cliff --latest --strip all > RELEASE_NOTES.md
          {
            echo 'body<<EOF'
            cat RELEASE_NOTES.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Push release commit and tag
        run: git push origin HEAD --follow-tags

  create-github-release:
    name: Create draft release
    runs-on: ubuntu-latest
    needs: prepare-release
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    permissions:
      contents: write
    steps:
      - name: Create GitHub release draft
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          release_name: ${{ needs.prepare-release.outputs.tag_name }}
          body: ${{ needs.prepare-release.outputs.changelog }}
          draft: true
          prerelease: false

  build-and-upload:
    name: Build and upload binaries
    runs-on: ${{ matrix.os }}
    needs:
      - prepare-release
      - create-github-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag_name }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build tesser-cli
        run: cargo build --package tesser-cli --release --target ${{ matrix.target }}

      - name: Package binary
        shell: bash
        run: |
          set -euo pipefail
          CLI_NAME="tesser-cli"
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            CLI_NAME="tesser-cli.exe"
          fi
          ARTIFACT_NAME="tesser-cli-${{ needs.prepare-release.outputs.tag_name }}-${{ matrix.target }}"
          ARTIFACT_DIR="$ARTIFACT_NAME"
          mkdir -p "$ARTIFACT_DIR"
          cp "target/${{ matrix.target }}/release/${CLI_NAME}" "$ARTIFACT_DIR/"
          if [[ "${{ matrix.archive }}" == "zip" ]]; then
            ARCHIVE_PATH="${ARTIFACT_NAME}.zip"
            7z a "$ARCHIVE_PATH" "./$ARTIFACT_DIR/*" >/dev/null
          else
            ARCHIVE_PATH="${ARTIFACT_NAME}.tar.gz"
            tar -czf "$ARCHIVE_PATH" -C "$ARTIFACT_DIR" .
          fi
          echo "ASSET_PATH=$ARCHIVE_PATH" >> "$GITHUB_ENV"
          echo "ASSET_NAME=$ARCHIVE_PATH" >> "$GITHUB_ENV"

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-github-release.outputs.upload_url }}
          asset_path: ${{ env.ASSET_PATH }}
          asset_name: ${{ env.ASSET_NAME }}
          asset_content_type: application/octet-stream

  publish-crates:
    name: Publish crates.io packages
    runs-on: ubuntu-latest
    needs:
      - prepare-release
      - create-github-release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag_name }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Compute publish order
        id: publish_order
        run: |
          ORDER=$(python scripts/compute_publish_order.py)
          {
            echo 'crates<<EOF'
            echo "$ORDER"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Publish crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "::error::CRATES_IO_TOKEN secret is not configured."
            exit 1
          fi
          while IFS= read -r crate; do
            [ -z "$crate" ] && continue
            echo "::group::Publishing $crate"
            cargo publish -p "$crate"
            echo "::endgroup::"
            sleep 30
          done <<< "${{ steps.publish_order.outputs.crates }}"

  publish-release:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    needs:
      - build-and-upload
      - publish-crates
      - create-github-release
    permissions:
      contents: write
    steps:
      - name: Publish draft release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-github-release.outputs.release_id }},
              draft: false
            });
